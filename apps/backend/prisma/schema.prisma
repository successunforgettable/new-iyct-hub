generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                  @id @default(uuid())
  email                 String                  @unique
  passwordHash          String?
  fullName              String
  userRole              UserRole
  phone                 String?
  address               String?
  city                  String?
  country               String?
  timezone              String                  @default("UTC")
  language              String                  @default("en")
  currency              String                  @default("USD")
  googleId              String?                 @unique
  facebookId            String?                 @unique
  oauthProvider         String?
  emailVerified         Boolean                 @default(false)
  emailVerifiedAt       DateTime?
  consentGiven          Boolean                 @default(false)
  consentTimestamp      DateTime?
  consentIp             String?
  dataRetentionDays     Int                     @default(365)
  scheduledDeletionDate DateTime?
  parentCoachId         String?
  status                UserStatus              @default(ACTIVE)
  lastLoginAt           DateTime?
  lastLoginIp           String?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  adminRoles            AdminRole[]
  aiGeneratedContent    AiGeneratedContent[]
  auditLogs             AuditLog[]
  buzzMoments           BuzzMoment[]
  certifications        Certification[]
  files                 File[]
  gdprRequests          GdprDataRequest[]
  innerDnaResult        InnerDnaResult?
  invoices              Invoice[]
  kycDocuments          KycDocument[]
  payments              Payment[]
  userBaselines         UserBaseline[]
  userNCodes            UserNCode[]
  userOutcomes          UserOutcome[]
  programEnrollments    UserProgramEnrollment[]
  sessions              UserSession[]
  stepProgress          UserStepProgress[]
  parentCoach           User?                   @relation("CoachToClients", fields: [parentCoachId], references: [id])
  clients               User[]                  @relation("CoachToClients")
  wheelOfLife           WheelOfLife[]

  @@index([email])
  @@index([googleId])
  @@index([userRole])
  @@index([status])
  @@index([parentCoachId])
  @@map("users")
}

model AdminRole {
  id          String   @id @default(uuid())
  userId      String
  roleName    String
  permissions Json
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleName])
  @@map("admin_roles")
}

model UserSession {
  id           String   @id @default(uuid())
  userId       String
  jwtToken     String
  refreshToken String?
  expiresAt    DateTime
  deviceInfo   Json?
  ipAddress    String?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([jwtToken])
  @@map("user_sessions")
}

model Program {
  id                    String                  @id @default(uuid())
  slug                  String                  @unique
  name                  String
  description           String?
  programType           ProgramType
  language              String                  @default("en")
  welcomeMessage        String?
  termsConditions       String?
  supportEmail          String?
  durationWeeks         Int?
  isPublished           Boolean                 @default(false)
  requiresCertification Boolean                 @default(false)
  basePriceUsd          Decimal?                @db.Decimal(10, 2)
  basePriceInr          Decimal?                @db.Decimal(10, 2)
  basePriceAed          Decimal?                @db.Decimal(10, 2)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  imageUrl              String?
  certifications        Certification[]
  pricingPlans          PricingPlan[]
  weeks                 ProgramWeek[]
  enrollments           UserProgramEnrollment[]

  @@index([programType])
  @@index([language])
  @@index([isPublished])
  @@map("programs")
}

model ProgramWeek {
  id              String        @id @default(uuid())
  programId       String
  weekNumber      Int
  title           String
  description     String?
  objectives      String[]
  isLocked        Boolean       @default(false)
  unlockAfterWeek Int?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  imageUrl        String?
  steps           ProgramStep[]
  program         Program       @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([programId, weekNumber])
  @@index([programId])
  @@map("program_weeks")
}

model ProgramStep {
  id              String             @id @default(uuid())
  weekId          String
  stepNumber      Int
  title           String
  contentType     String?
  contentUrl      String?
  contentHtml     String?
  durationMinutes Int?
  isMandatory     Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  assignments     Assignment[]
  week            ProgramWeek        @relation(fields: [weekId], references: [id], onDelete: Cascade)
  userProgress    UserStepProgress[]

  @@unique([weekId, stepNumber])
  @@index([weekId])
  @@map("program_steps")
}

model Assignment {
  id               String      @id @default(uuid())
  stepId           String
  title            String
  instructions     String
  submissionType   String?
  maxFileSizeMb    Int?
  allowedFileTypes String[]
  usesAiGeneration Boolean     @default(false)
  aiPromptTemplate String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  step             ProgramStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@map("assignments")
}

model UserProgramEnrollment {
  id                   String             @id @default(uuid())
  userId               String
  programId            String
  enrolledAt           DateTime           @default(now())
  enrollmentStatus     EnrollmentStatus   @default(ACTIVE)
  paymentStatus        PaymentStatus      @default(FREE)
  accessGrantedAt      DateTime           @default(now())
  accessExpiresAt      DateTime?
  completionPercentage Int                @default(0)
  currentWeek          Int                @default(1)
  lastActivityAt       DateTime?
  completedAt          DateTime?
  updatedAt            DateTime           @updatedAt
  payments             Payment[]
  program              Program            @relation(fields: [programId], references: [id], onDelete: Cascade)
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  stepProgress         UserStepProgress[]

  @@unique([userId, programId])
  @@index([userId])
  @@index([programId])
  @@index([enrollmentStatus])
  @@map("user_program_enrollment")
}

model UserStepProgress {
  id                 String                @id @default(uuid())
  userId             String
  stepId             String
  enrollmentId       String
  status             String                @default("not_started")
  startedAt          DateTime?
  completedAt        DateTime?
  timeSpentSeconds   Int                   @default(0)
  submissionText     String?
  submissionFileUrl  String?
  submissionMetadata Json?
  aiGeneratedContent Json?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  enrollment         UserProgramEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  step               ProgramStep           @relation(fields: [stepId], references: [id], onDelete: Cascade)
  user               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, stepId])
  @@index([userId])
  @@index([stepId])
  @@map("user_step_progress")
}

model InnerDnaResult {
  id              String         @id @default(uuid())
  userId          String         @unique
  personalityType Int?
  wing            String?
  subtype         String?
  blindSubtype    String?
  states          Json?
  innerDnaUserId  String?
  rawResponse     Json?
  testCompletedAt DateTime?
  testVersion     String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  userBaselines   UserBaseline[]
  userNCodes      UserNCode[]
  wheelOfLife     WheelOfLife[]

  @@index([personalityType])
  @@map("inner_dna_results")
}

model AiGeneratedContent {
  id                 String    @id @default(uuid())
  userId             String
  contentType        String
  contentSubtype     String?
  personalityContext Json?
  inputData          Json?
  promptTemplate     String?
  generatedContent   String
  formattedHtml      String?
  modelVersion       String?
  tokensUsed         Int?
  generationTimeMs   Int?
  costUsd            Decimal?  @db.Decimal(10, 4)
  isCached           Boolean   @default(true)
  expiresAt          DateTime?
  cacheKey           String?   @unique
  userEdited         Boolean   @default(false)
  userApproved       Boolean   @default(false)
  regenerationCount  Int       @default(0)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([contentType])
  @@index([cacheKey])
  @@index([expiresAt])
  @@map("ai_generated_content")
}

model WheelOfLife {
  id             String          @id @default(uuid())
  userId         String
  innerDnaId     String?
  health         Int
  friendsFamily  Int
  funRecreation  Int
  wealth         Int
  relationship   Int
  learningGrowth Int
  possessions    Int
  career         Int
  aiInsightsId   String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  innerDna       InnerDnaResult? @relation(fields: [innerDnaId], references: [id])
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("wheel_of_life")
}

model UserBaseline {
  id                  String          @id @default(uuid())
  userId              String
  innerDnaId          String?
  baselineWords       String[]
  wordRankings        Int[]
  baselineExpressions Json?
  expressionRatings   Json?
  aiVisionsId         String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  innerDna            InnerDnaResult? @relation(fields: [innerDnaId], references: [id])
  user                User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_baselines")
}

model UserNCode {
  id                 String          @id @default(uuid())
  userId             String
  innerDnaId         String?
  ncodeStatement     String
  ncodeRanking       Int?
  ecodeStatement     String
  lifeAreaImpacts    Json?
  fiveYearPrediction String?
  aiPredictionId     String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  innerDna           InnerDnaResult? @relation(fields: [innerDnaId], references: [id])
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_ncodes")
}

model UserOutcome {
  id                 String   @id @default(uuid())
  userId             String
  outcomeTitle       String
  outcomeDescription String?
  outcomeRank        Int
  incredSteps        Json?
  aiIncredId         String?
  challenges         Json?
  powerLeaps         Json?
  aiChallengesId     String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_outcomes")
}

model BuzzMoment {
  id                String   @id @default(uuid())
  userId            String
  momentDescription String
  isAiSuggested     Boolean  @default(false)
  aiContentId       String?
  createdAt         DateTime @default(now())
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("buzz_moments")
}

model PricingPlan {
  id                   String      @id @default(uuid())
  programId            String
  planName             String
  paymentType          PaymentType
  priceUsd             Decimal?    @db.Decimal(10, 2)
  priceInr             Decimal?    @db.Decimal(10, 2)
  priceAed             Decimal?    @db.Decimal(10, 2)
  installmentCount     Int?
  installmentFrequency String?
  isActive             Boolean     @default(true)
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  payments             Payment[]
  program              Program     @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([programId])
  @@map("pricing_plans")
}

model Payment {
  id                   String                 @id @default(uuid())
  userId               String
  enrollmentId         String?
  planId               String?
  amount               Decimal                @db.Decimal(10, 2)
  currency             String
  paymentGateway       PaymentGateway
  gatewayTransactionId String?
  gatewayPaymentMethod String?
  gatewayResponse      Json?
  status               TransactionStatus      @default(PENDING)
  taxRate              Decimal?               @db.Decimal(5, 2)
  taxAmount            Decimal?               @db.Decimal(10, 2)
  totalAmount          Decimal                @db.Decimal(10, 2)
  isInstallment        Boolean                @default(false)
  installmentNumber    Int?
  totalInstallments    Int?
  paymentMetadata      Json?
  ipAddress            String?
  initiatedAt          DateTime               @default(now())
  completedAt          DateTime?
  failedAt             DateTime?
  invoices             Invoice[]
  enrollment           UserProgramEnrollment? @relation(fields: [enrollmentId], references: [id])
  plan                 PricingPlan?           @relation(fields: [planId], references: [id])
  user                 User                   @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([enrollmentId])
  @@index([gatewayTransactionId])
  @@index([status])
  @@map("payments")
}

model Invoice {
  id             String    @id @default(uuid())
  paymentId      String?
  userId         String
  invoiceNumber  String    @unique
  invoiceDate    DateTime
  dueDate        DateTime?
  pdfUrl         String?
  pdfGeneratedAt DateTime?
  createdAt      DateTime  @default(now())
  payment        Payment?  @relation(fields: [paymentId], references: [id])
  user           User      @relation(fields: [userId], references: [id])

  @@index([invoiceNumber])
  @@index([userId])
  @@map("invoices")
}

model Certification {
  id                  String               @id @default(uuid())
  userId              String
  programId           String?
  certificationType   String?
  certificationNumber String?              @unique
  status              CertificationStatus  @default(PENDING)
  certificatePdfUrl   String?
  certificateIssuedAt DateTime?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  videos              CertificationVideo[]
  program             Program?             @relation(fields: [programId], references: [id])
  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("certifications")
}

model CertificationVideo {
  id                String              @id @default(uuid())
  certificationId   String
  videoUrl          String
  videoThumbnailUrl String?
  durationSeconds   Int?
  status            CertificationStatus @default(PENDING)
  reviewerId        String?
  reviewNotes       String?
  reviewedAt        DateTime?
  aiAnalysis        Json?
  uploadedAt        DateTime            @default(now())
  certification     Certification       @relation(fields: [certificationId], references: [id], onDelete: Cascade)

  @@index([certificationId])
  @@index([status])
  @@map("certification_videos")
}

model KycDocument {
  id               String    @id @default(uuid())
  userId           String
  documentType     String
  documentNumber   String?
  frontImageUrl    String?
  backImageUrl     String?
  selfieUrl        String?
  status           KYCStatus @default(NOT_STARTED)
  verifiedById     String?
  verifiedAt       DateTime?
  rejectionReason  String?
  consentGiven     Boolean   @default(false)
  consentTimestamp DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("kyc_documents")
}

model AuditLog {
  id               String   @id @default(uuid())
  userId           String?
  adminUserId      String?
  eventType        String
  eventCategory    String?
  eventDescription String?
  resourceType     String?
  resourceId       String?
  changes          Json?
  metadata         Json?
  ipAddress        String?
  userAgent        String?
  requestId        String?
  createdAt        DateTime @default(now())
  user             User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("audit_logs")
}

model GdprDataRequest {
  id            String    @id @default(uuid())
  userId        String
  requestType   String
  requestStatus String    @default("pending")
  processedById String?
  processedAt   DateTime?
  exportFileUrl String?
  createdAt     DateTime  @default(now())
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([requestStatus])
  @@map("gdpr_data_requests")
}

model File {
  id              String    @id @default(uuid())
  userId          String?
  fileName        String
  filePath        String
  fileSizeBytes   BigInt?
  mimeType        String?
  storageProvider String    @default("aws_s3")
  storageKey      String?
  isPublic        Boolean   @default(false)
  expiresAt       DateTime?
  uploadedById    String?
  fileCategory    String?
  createdAt       DateTime  @default(now())
  user            User?     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([fileCategory])
  @@map("files")
}

enum UserRole {
  SUPERADMIN
  ADMIN
  COACH
  CLIENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum ProgramType {
  HUB
  FREE
  OUTSIDE
}
enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  SUSPENDED
}

enum PaymentStatus {
  PAID
  INSTALLMENT
  FREE
  TRIAL
}

enum PaymentGateway {
  STRIPE
  CASHFREE
}

enum PaymentType {
  FULL
  INSTALLMENT
  SUBSCRIPTION
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum CertificationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum KYCStatus {
  NOT_STARTED
  SUBMITTED
  VERIFIED
  REJECTED
}
